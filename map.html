<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NSW PSN â€“ Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* LAYOUT OVERRIDES */
    body, html { width: 100%; height: 100%; overflow: hidden; padding: 0 !important; margin: 0 !important; }
    
    #map-layout-root {
      position: absolute; top: 0; left: 260px; right: 0; bottom: 0;
      width: auto !important; height: 100% !important; padding: 0 !important; margin: 0 !important;
      max-width: none !important;
    }

    @media (max-width: 900px) {
      #map-layout-root { left: 0; top: 60px; height: calc(100% - 60px); }
    }

    .map-container { width: 100%; height: 100%; position: relative; }
    #map { width: 100%; height: 100%; background: #0f172a; z-index: 1; }

    /* CONTROLS & TOGGLES */
    .layer-toggles {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 800;
      display: flex; gap: 10px; background: rgba(15, 23, 42, 0.9); padding: 6px 12px;
      border-radius: 50px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    
    .map-type-controls {
      position: absolute; bottom: 30px; left: 20px; z-index: 800;
      display: flex; gap: 6px; background: rgba(15, 23, 42, 0.9); padding: 6px 10px;
      border-radius: 50px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .btn-toggle {
      background: transparent; border: none; color: #cbd5e1; padding: 6px 10px; border-radius: 20px;
      font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;
      transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .btn-toggle:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .btn-toggle.active { background: rgba(255, 255, 255, 0.1); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .btn-toggle.active#btn-user { border: 1px solid #a855f7; color: #d8b4fe; }
    .btn-toggle.active#btn-rfs { border: 1px solid #ef4444; color: #fca5a5; }
    .btn-toggle.active#btn-list { border: 1px solid #3b82f6; color: #93c5fd; }
    .btn-toggle.active.map-type-btn { border: 1px solid #f97316; color: #fdba74; }
    .btn-toggle:not(.active) { opacity: 0.6; }
    .dot-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .btn-toggle.active .dot-indicator { box-shadow: 0 0 8px currentColor; }

    /* SIDEBARS */
    .map-sidebar {
      width: 350px; background: rgba(15, 23, 42, 0.95); border-left: 1px solid rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(12px); padding: 1.5rem; overflow-y: auto; position: absolute; right: 0; top: 0;
      height: 100%; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; box-shadow: -5px 0 25px rgba(0,0,0,0.5);
    }
    #list-sidebar { z-index: 1004; }
    #incident-sidebar { z-index: 1005; }
    .map-sidebar.open { transform: translateX(0); }
    
    /* FILTER STYLES (RESTORED) */
    .filter-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.4rem; }
    .filter-actions { font-size: 0.7rem; color: var(--accent); cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
    .filter-actions:hover { text-decoration: underline; color: #fff; }

    .filter-group { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
    
    .filter-pill { 
      padding: 0.25rem 0.7rem; border-radius: 999px; font-size: 0.7rem; text-transform: uppercase; 
      /* Default (Inactive/Red) */
      background: rgba(127, 29, 29, 0.6); 
      border: 1px solid #ef4444; 
      color: #fca5a5;
      cursor: pointer; transition: all 0.15s; user-select: none; display: flex; align-items: center; gap: 6px;
    }
    .filter-pill:hover { background: rgba(185, 28, 28, 0.8); color: #fff; }
    
    /* Active (Showing/Green) */
    .filter-pill.active { 
      background: rgba(21, 128, 61, 0.8) !important; 
      border-color: #22c55e !important; 
      color: #fff !important; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-weight: 600; 
    }
    .filter-pill.active:hover { background: rgba(22, 163, 74, 0.9) !important; }
    
    /* LIST ITEMS & BADGES */
    .incident-list-item { padding: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; border-radius: 6px; margin-bottom: 0.2rem; }
    .incident-list-item:hover { background: rgba(255,255,255,0.05); }
    .incident-list-item h4 { margin: 0 0 0.3rem 0; font-size: 0.95rem; color: #fff; }
    .incident-list-meta { font-size: 0.75rem; color: #94a3b8; display: flex; gap: 0.5rem; align-items: center; }
    
    .pill-meta { font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 4px; border: 1px solid rgba(148,163,184,0.3); color: #cbd5e1; background: rgba(30, 41, 59, 0.5); display: inline-block; }
    
    /* SEARCH RESULTS (Added for Map.html) */
    .search-results {
      background: #1e293b; border: 1px solid rgba(148, 163, 184, 0.35); border-radius: 8px; margin-top: 0.4rem;
      max-height: 250px; overflow-y: auto; position: absolute; width: 100%; z-index: 1050; display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .search-result-item { padding: 0.8rem; font-size: 0.85rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; }
    .search-result-item:hover { background: rgba(249, 115, 22, 0.2); color: #fff; }

    /* PULSE ANIMATION FIX */
    .rfs-pulse {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: pulse-red 2s infinite;
      border-radius: 50%;
    }
    @keyframes pulse-red {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 4px 10px rgba(239, 68, 68, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* RESET FILTERS */
    .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution,
    .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-popup, .leaflet-tooltip { filter: none !important; }

    /* DARK MODE (Only applies when 'Dark' button is clicked) */
    .map-dark-mode .leaflet-layer,
    .map-dark-mode .leaflet-control-zoom-in,
    .map-dark-mode .leaflet-control-zoom-out,
    .map-dark-mode .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%) !important; }
    .map-dark-mode .leaflet-marker-icon,
    .map-dark-mode .leaflet-marker-shadow,
    .map-dark-mode .leaflet-popup,
    .map-dark-mode .leaflet-tooltip { filter: invert(100%) hue-rotate(180deg) !important; }
  </style>
</head>
<body>
  <div class="mobile-header">
    <div class="mobile-logo">Forcequit <span>Map</span></div>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
  </div>

  <div class="menu-overlay" onclick="toggleSidebar()"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">Forcequit <span>NSW PSN</span></div>
    <div class="sidebar-subtitle">Quick reference handbook for NSW Public Safety Network monitoring.</div>
    <div class="sidebar-section-label">Sections</div>
    <nav class="sidebar-nav">
      <a href="index.html">Home / Overview</a>
      <a href="live.html" style="color: #fca5a5;">Live Data / Scanner</a>
      <a class="active" href="map.html" style="color: #fca5a5;">Incident Map</a>
      <a href="fire-and-rescue.html">Fire and Rescue NSW</a>
      <a href="ambulance.html">NSW Ambulance</a>
      <a href="rural-fire-service.html">NSW Rural Fire Service</a>
      <a href="aviation.html">Aviation &amp; Callsigns</a>
      <a href="links.html">Useful Links</a>
    </nav>
    <div class="sidebar-section-label">Legal</div>
    <nav class="sidebar-nav">
      <a href="terms.html">Terms &amp; Conditions</a>
      <a href="privacy.html">Privacy Policy</a>
    </nav>
    <div class="sidebar-section-label">Live Scanner</div>
    <div class="sidebar-highlight">
      <div class="sidebar-highlight-title">NSW PSN Scanner</div>
      <div>Hosted by Forcequit</div>
      <div style="margin-top:0.45rem;">
        <a class="listen-btn-wide" href="https://radio.forcequit.xyz/" target="_blank" rel="noopener noreferrer">Live feed</a>
      </div>
      <div style="margin-top:0.45rem;">
        <a class="discord-btn-wide" href="https://discord.gg/BthQzXj6Ck" target="_blank" rel="noopener noreferrer">Support Discord</a>
      </div>
      <div style="margin-top:0.25rem; font-size:0.7rem; color:var(--text-soft);">radio.forcequit.xyz</div>
    </div>
    <div class="sidebar-footer">NSW PSN Reference Â· Forcequit</div>
  </aside>

  <main class="main" id="map-layout-root">
    <div class="map-container">
      <div id="map"></div>
      <div class="layer-toggles">
        <button id="btn-user" class="btn-toggle active" onclick="toggleMapLayer('user')"><span class="dot-indicator" style="background:#a855f7;"></span> User</button>
        <button id="btn-rfs" class="btn-toggle active" onclick="toggleMapLayer('rfs')"><span class="dot-indicator" style="background:#ef4444;"></span> RFS</button>
        <button id="btn-list" class="btn-toggle" onclick="toggleListSidebar()"><span>ðŸ“‹</span> List</button>
      </div>
      <div class="map-type-controls">
        <button class="btn-toggle map-type-btn active" id="btn-type-dark" onclick="setMapType('dark')">Dark</button>
        <button class="btn-toggle map-type-btn" id="btn-type-sat" onclick="setMapType('sat')">Sat</button>
        <button class="btn-toggle map-type-btn" id="btn-type-topo" onclick="setMapType('topo')">Topo</button>
      </div>
      <div class="map-sidebar" id="list-sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <h3 style="margin:0; color:#fff;">Incidents</h3>
          <button class="btn btn-secondary" onclick="toggleListSidebar()" style="padding:0.4rem 0.8rem; font-size:0.75rem;">Close âœ•</button>
        </div>
        
        <div class="form-group" style="position:relative; margin-bottom:1.5rem; padding-bottom:1.5rem; border-bottom:1px solid rgba(148,163,184,0.2);">
          <label class="form-label">Jump to Address</label>
          <div style="display:flex; gap:5px;">
            <input type="text" id="address-search" class="form-input" placeholder="Town or Address..." autocomplete="off" style="padding:0.5rem; font-size:0.85rem; border-radius:20px; background:rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.1); color:#fff; width:100%;">
            <button class="btn btn-secondary" onclick="performAddressSearch()" style="padding:0.4rem 0.8rem; border-radius:20px; font-size:0.75rem;">Go</button>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>

        <div class="filter-section" style="margin-bottom:0.5rem; padding-bottom:1rem; border-bottom:1px solid rgba(148,163,184,0.2);">
          <div style="margin-bottom:1rem;">
            <label class="form-label">Filter Incidents</label>
            <input type="text" id="filter-search" class="form-input" placeholder="Filter by Title, Type or Street..." onkeyup="refreshMapAndList()" style="padding:0.5rem; font-size:0.85rem; border-radius:20px; background:rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.1); color:#fff; width:100%;">
          </div>
          <div class="filter-header"><label class="form-label" style="font-size:0.7rem; color:#94a3b8; margin:0;">Agencies</label><div style="display:flex; gap:8px;"><span class="filter-actions" onclick="bulkFilter('agency', true)">All</span><span class="filter-actions" onclick="bulkFilter('agency', false)">None</span></div></div>
          <div id="filter-container-agency" class="filter-group"></div>
          <div class="filter-header" style="margin-top:1rem;"><label class="form-label" style="font-size:0.7rem; color:#94a3b8; margin:0;">Specific Types</label><div style="display:flex; gap:8px;"><span class="filter-actions" onclick="bulkFilter('type', true)">All</span><span class="filter-actions" onclick="bulkFilter('type', false)">None</span></div></div>
          <div id="filter-container-type" class="filter-group"></div>
        </div>
        <div id="incident-list-container" style="flex:1; overflow-y:auto;">
          <div style="text-align:center; color:var(--text-soft); font-size:0.9rem; padding:2rem;">Loading incidents...</div>
        </div>
      </div>
      <div class="map-sidebar" id="incident-sidebar">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="closeIncidentSidebar()" style="padding:0.4rem 0.8rem; font-size:0.75rem;">Close âœ•</button>
        </div>
        <div id="sidebar-content" style="margin-top:1rem;">
          <div style="text-align:center; color:var(--text-soft); margin-top:2rem;">Select a pin on the map<br>to view details.</div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const SUPABASE_URL = 'https://wwcickcmezfrcqyclcuo.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3Y2lja2NtZXpmcmNxeWNsY3VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODI3NDIsImV4cCI6MjA4MDA1ODc0Mn0.xP9I9vAbBB-1afCpnOAwLJeoKTF2Dmewwv-aCKVXKrQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const darkBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB', subdomains: 'abcd', maxZoom: 19 });
    const satBase = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 21, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], maxNativeZoom: 19, attribution: 'Â© Google' });
    const topoBase = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'Map data: &copy; OpenStreetMap | Map style: &copy; OpenTopoMap', maxZoom: 17 });

    const map = L.map('map', { zoomControl: false, layers: [darkBase] }).setView([-33.8688, 151.2093], 7);
    document.getElementById('map').classList.add('map-dark-mode');
    L.control.zoom({ position: 'topright' }).addTo(map);

    function setMapType(type) {
      map.removeLayer(darkBase); map.removeLayer(satBase); map.removeLayer(topoBase);
      document.querySelectorAll('.map-type-btn').forEach(btn => btn.classList.remove('active'));
      const mapDiv = document.getElementById('map');
      if (type === 'dark') { map.addLayer(darkBase); mapDiv.classList.add('map-dark-mode'); document.getElementById('btn-type-dark').classList.add('active'); }
      else if (type === 'sat') { map.addLayer(satBase); mapDiv.classList.remove('map-dark-mode'); document.getElementById('btn-type-sat').classList.add('active'); }
      else if (type === 'topo') { map.addLayer(topoBase); mapDiv.classList.remove('map-dark-mode'); document.getElementById('btn-type-topo').classList.add('active'); }
    }

    const userLayer = L.layerGroup().addTo(map);
    const rfsLayer = L.layerGroup().addTo(map);
    let unifiedIncidents = [], filterState = { agency: {}, type: {} };
    const AGENCY_COLORS = { 'RFS': '#ff6600', 'FRNSW': '#ef4444', 'NSWAS': '#3b82f6', 'SES': '#eab308', 'POLICE': '#3b82f6', 'VRA': '#000000', 'AVIATION': '#a855f7' };
    const TYPE_COLORS = { 'FIRE': '#ef4444', 'RESCUE': '#ff6600', 'HAZARD': '#eab308', 'POLICE': '#3b82f6', 'MEDICAL': '#3b82f6', 'DEFAULT': '#000000' };

    // --- FIX: Deterministic UUID generator for RFS links ---
    function generateRfsId(url) {
        let hash = 0;
        for (let i = 0; i < url.length; i++) {
            hash = ((hash << 5) - hash) + url.charCodeAt(i);
            hash |= 0;
        }
        let hex = (hash >>> 0).toString(16).padStart(8, '0');
        let finalHex = (hex + hex + hex + hex).slice(0, 32);
        return finalHex.slice(0, 8) + '-' + finalHex.slice(8, 12) + '-' + '4' + finalHex.slice(13, 16) + '-' + 'a' + finalHex.slice(17, 20) + '-' + finalHex.slice(20, 32);
    }

    function toggleMapLayer(target) {
      const btn = document.getElementById(target === 'user' ? 'btn-user' : 'btn-rfs');
      const layer = target === 'user' ? userLayer : rfsLayer;
      if (map.hasLayer(layer)) { map.removeLayer(layer); btn.classList.remove('active'); } 
      else { map.addLayer(layer); btn.classList.add('active'); }
      refreshMapAndList();
    }
    
    function toggleListSidebar() { document.getElementById('list-sidebar').classList.toggle('open'); document.getElementById('btn-list').classList.toggle('active'); }
    function closeIncidentSidebar() { document.getElementById('incident-sidebar').classList.remove('open'); }

    async function loadAllData() {
      const nowISO = new Date().toISOString();
      // Filter out records that are just stubs for RFS logs
      const { data: userIncidents } = await supabase
          .from('incidents')
          .select('*')
          .gt('expires_at', nowISO)
          .eq('is_rfs_stub', false); 
      
      let rfsItems = [];
      try {
        const res = await fetch("https://www.rfs.nsw.gov.au/feeds/majorIncidents.xml");
        const text = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");
        xml.querySelectorAll("item").forEach((item, idx) => {
          const title = item.querySelector("title").textContent;
          const link = item.querySelector("link").textContent;
          const guid = item.querySelector("guid") ? item.querySelector("guid").textContent : link;
          const descHtml = item.querySelector("description").textContent;
          const pointStr = item.querySelector("point") ? item.querySelector("point").textContent : null;
          const details = parseRfsDescription(descHtml);
          details.title = title; details.link = link;
          let lat = null, lng = null;
          if (pointStr) [lat, lng] = pointStr.split(' ').map(Number);
          if(lat && lng) { rfsItems.push({ id: generateRfsId(guid), source: 'rfs', title: title, rawDetails: details, link: link, typeDisplay: details.TYPE || 'Fire', typesList: [details.TYPE || 'Fire'], agenciesList: ['RFS'], lat: lat, lng: lng, alertLevel: (details['ALERT LEVEL'] || '').toLowerCase() }); }
        });
      } catch (e) { console.error("RFS Feed Error", e); }

      unifiedIncidents = [];
      if(userIncidents) {
        userIncidents.forEach(inc => {
          let displayType = Array.isArray(inc.type) ? inc.type.join(', ') : inc.type;
          let typesList = Array.isArray(inc.type) ? inc.type : [inc.type];
          let agList = inc.responding_agencies || [];
          if(agList.length === 0) agList = ['Other'];
          unifiedIncidents.push({ id: inc.id, source: 'user', title: inc.title, rawDetails: inc, typeDisplay: displayType, typesList: typesList, agenciesList: agList, lat: inc.lat, lng: inc.lng });
        });
      }
      unifiedIncidents = [...unifiedIncidents, ...rfsItems];
      unifiedIncidents.forEach(item => {
        item.agenciesList.forEach(a => { if(!(a in filterState.agency)) filterState.agency[a] = true; });
        item.typesList.forEach(t => { if(!(t in filterState.type)) filterState.type[t] = true; });
      });
      refreshMapAndList();
    }

    // FIXED: Updated Search logic to include Location and Type fields
    function refreshMapAndList() {
      const searchTerm = (document.getElementById('filter-search').value || '').toLowerCase();
      const listContainer = document.getElementById('incident-list-container');
      const showUser = document.getElementById('btn-user').classList.contains('active');
      const showRfs = document.getElementById('btn-rfs').classList.contains('active');
      let counts = { agency: {}, type: {} };
      Object.keys(filterState.agency).forEach(k => counts.agency[k] = 0);
      Object.keys(filterState.type).forEach(k => counts.type[k] = 0);

      const filteredItems = unifiedIncidents.filter(item => {
        if(item.source === 'user' && !showUser) return false;
        if(item.source === 'rfs' && !showRfs) return false;
        item.agenciesList.forEach(a => counts.agency[a] = (counts.agency[a] || 0) + 1);
        item.typesList.forEach(t => counts.type[t] = (counts.type[t] || 0) + 1);
        
        if (searchTerm) {
            // Expanded search logic
            const titleMatch = item.title.toLowerCase().includes(searchTerm);
            const locationMatch = (item.rawDetails.LOCATION || '').toLowerCase().includes(searchTerm);
            const typeMatch = item.typeDisplay.toLowerCase().includes(searchTerm);
            if (!titleMatch && !locationMatch && !typeMatch) return false;
        }
        
        if (!item.agenciesList.some(a => filterState.agency[a] === true)) return false;
        if (!item.typesList.some(t => filterState.type[t] === true)) return false;
        return true;
      });

      renderFilterButtons('agency', counts.agency);
      renderFilterButtons('type', counts.type);
      userLayer.clearLayers(); rfsLayer.clearLayers();

      filteredItems.forEach(item => {
        if(item.source === 'user') {
          const style = getPinStyle(item.rawDetails);
          const status = (item.rawDetails.status || 'Going').toLowerCase();
          
          let pulseClass = '';
          let shadowStyle = ''; 

          if (status.includes('emergency')) {
            pulseClass = 'rfs-pulse'; 
          } else if (status.includes('out of control')) {
            shadowStyle = 'box-shadow: 0 0 10px #ef4444; border-color: #ef4444;';
          } else if (status.includes('watch')) {
            shadowStyle = 'box-shadow: 0 0 10px #f97316; border-color: #f97316;'; 
          } else if (status.includes('being controlled')) {
            shadowStyle = 'box-shadow: 0 0 10px #eab308; border-color: #eab308;'; // Yellow
          } else if (status.includes('advice')) {
            shadowStyle = 'box-shadow: 0 0 8px #3b82f6; border-color: #3b82f6;'; 
          } else if (status.includes('monitor') || status.includes('investigation')) {
            shadowStyle = 'box-shadow: 0 0 8px #a855f7; border-color: #a855f7;'; // Purple
          } else if (status.includes('contained') || status.includes('control') || status.includes('safe') || status.includes('patrol')) {
            shadowStyle = 'box-shadow: 0 0 8px #22c55e; border-color: #22c55e;'; 
          } else if (status.includes('pending')) {
            shadowStyle = 'box-shadow: 0 0 8px #94a3b8; border-color: #94a3b8;'; // Grey
          } else if (status.includes('on scene')) {
            shadowStyle = 'box-shadow: 0 0 10px #06b6d4; border-color: #06b6d4;'; // Cyan
          } else if (status.includes('in route')) {
            shadowStyle = 'box-shadow: 0 0 10px #d946ef; border-color: #d946ef;'; // Magenta
          } else if (status.includes('off scene')) {
            shadowStyle = 'box-shadow: 0 0 8px #64748b; border-color: #64748b;'; // Slate
          } else {
            shadowStyle = `box-shadow: 0 0 10px ${style.glow};`;
          }
          
          const iconHtml = `<div class="${pulseClass}" style="background:${style.background}; width:24px; height:24px; border-radius:50%; border:3px solid #fff; ${shadowStyle}"></div>`;
          const icon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [30,30], iconAnchor: [15,15] });
          const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(userLayer);
          marker.on('click', () => showIncidentDetails(item.rawDetails));
        } else {
          let color = '#000000'; let pulseClass = '';
          const al = item.alertLevel || '';
          
          let shadowStyle = '';
          if(al.includes('emergency')) { 
             color = '#ef4444'; pulseClass = 'rfs-pulse'; 
          } else if(al.includes('watch')) { 
             color = '#f97316'; shadowStyle = 'box-shadow: 0 0 10px #f97316; border-color: #f97316;';
          } else if(al.includes('advice')) { 
             color = '#3b82f6'; shadowStyle = 'box-shadow: 0 0 8px #3b82f6; border-color: #3b82f6;';
          } else {
             shadowStyle = 'box-shadow: 0 0 8px #000;';
          }
          
          const iconHtml = `<div class="${pulseClass}" style="background:${color}; width:18px; height:18px; border-radius:50%; border:2px solid #fff; ${shadowStyle}"></div>`;
          const icon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [24,24], iconAnchor: [12,12] });
          const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(rfsLayer);
          marker.on('click', () => showRfsDetails(item)); // Pass full item
        }
      });

      if (filteredItems.length === 0) { listContainer.innerHTML = '<div style="padding:1rem; color:var(--text-soft); text-align:center;">No incidents found.</div>'; return; }

      listContainer.innerHTML = filteredItems.map(item => {
        const agencyBadges = item.agenciesList.map(ag => {
            let badgeClass = 'pill-white';
            const a = ag.toUpperCase();
            if(a.includes('RFS')) badgeClass = 'pill-agency-rfs'; else if(a.includes('FRNSW')) badgeClass = 'pill-agency-frnsw'; else if(a.includes('NSWAS')) badgeClass = 'pill-agency-amb'; else if(a.includes('SES')) badgeClass = 'pill-agency-ses'; else if(a.includes('POLICE')) badgeClass = 'pill-blue';
            return `<span class="pill ${badgeClass}" style="font-size:0.65rem;">${ag}</span>`;
        }).join('');
        
        const st = item.rawDetails.status || item.rawDetails.STATUS || '';
        const sz = item.rawDetails.size || item.rawDetails.SIZE || '';
        
        const typeBadge = `<span class="pill-meta">${item.typeDisplay}</span>`;
        const statusBadge = st ? `<span class="pill-meta">${st}</span>` : '';
        const sizeBadge = sz ? `<span class="pill-meta">${sz}</span>` : '';

        return `<div class="incident-list-item" onclick="panToItem('${item.id}')">
          <h4>${item.title}</h4>
          <div style="margin-bottom:0.4rem; display:flex; gap:4px; flex-wrap:wrap;">
            ${typeBadge}
            ${statusBadge}
            ${sizeBadge}
          </div>
          <div class="incident-list-meta" style="flex-wrap:wrap; gap:0.3rem;">${agencyBadges}</div>
        </div>`;
      }).join('');
    }

    function renderFilterButtons(cat, counts) {
      const container = document.getElementById(`filter-container-${cat}`);
      const mapping = (cat === 'agency') ? { 'RFS': 'RFS', 'FRNSW': 'FRNSW', 'NSWAS': 'Ambulance', 'SES': 'SES', 'POLICE': 'Police' } : {}; 
      const keys = Object.keys(filterState[cat]).sort();
      container.innerHTML = keys.map(k => {
        if(counts[k] === 0) return ''; 
        const isActive = filterState[cat][k];
        const label = mapping[k] || k;
        const count = counts[k] || 0;
        return `<div class="filter-pill ${isActive ? 'active' : ''}" data-cat="${cat}" data-val="${k}" onclick="toggleFilter('${cat}', '${k}')">${label} <span class="count">(${count})</span></div>`;
      }).join('');
    }

    function toggleFilter(cat, key) { filterState[cat][key] = !filterState[cat][key]; refreshMapAndList(); }
    function bulkFilter(cat, visible) { Object.keys(filterState[cat]).forEach(k => filterState[cat][k] = visible); refreshMapAndList(); }
    function panToItem(id) {
      const item = unifiedIncidents.find(i => i.id === id);
      if(!item) return;
      map.setView([item.lat, item.lng], 14);
      if(item.source === 'user') showIncidentDetails(item.rawDetails); else showRfsDetails(item); // Pass full item
      if(window.innerWidth < 900) toggleListSidebar();
    }
    function parseRfsDescription(html) {
      const clean = html.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>?/gm, '');
      const lines = clean.split('\n');
      let data = {};
      lines.forEach(line => { const parts = line.split(':'); if(parts.length > 1) { data[parts[0].trim().toUpperCase()] = parts.slice(1).join(':').trim(); } });
      return data;
    }
    // Updated showRfsDetails to fetch and display user logs
    async function showRfsDetails(item) {
      const data = item.rawDetails;
      const sidebar = document.getElementById('incident-sidebar');
      const content = document.getElementById('sidebar-content');
      sidebar.classList.add('open');
      
      content.innerHTML = '<p style="color:var(--text-soft); text-align:center; margin-top:2rem;">Loading details and log...</p>';
      
      // Fetch logs using the incident's generated ID
      // FIX: Changed const to let for 'updates'
      let { data: updates, error: logError } = await supabase.from('incident_updates').select('*').eq('incident_id', item.id).order('created_at', { ascending: false });
      
      let updatesHtml;
      if (logError) {
          updatesHtml = `<div style="color:#ef4444; font-size:0.85rem; margin-top:1rem; font-style:italic;">Error loading user logs: ${logError.message}</div>`;
      } else if (updates && updates.length > 0) {
          updates = updates.map(u => ({...u, isNew: u.id === item.latestUpdateId})); // Mark latest for highlight if needed
          updatesHtml = `<div class="update-timeline">` + updates.map(u => `<div class="update-item"><div class="update-time">${new Date(u.created_at).toLocaleString()}</div><div class="update-msg markdown-body">${marked.parse(u.message)}</div></div>`).join('') + `</div>`;
      } else {
          updatesHtml = '<div style="font-size:0.85rem; color:var(--text-soft); margin-top:1rem; font-style:italic;">No user updates yet.</div>';
      }
      
      let badgeClass = "pill-white";
      const lvl = (data['ALERT LEVEL'] || '').toLowerCase();
      if(lvl.includes('emergency')) badgeClass = "pill-red"; else if(lvl.includes('watch')) badgeClass = "pill-orange"; else if(lvl.includes('advice')) badgeClass = "pill-blue";
      
      content.innerHTML = `<div style="margin-bottom:0.5rem;"><span class="pill pill-agency-rfs">NSW RFS FEED</span><span class="pill ${badgeClass}">${data['ALERT LEVEL'] || 'Incident'}</span></div><h2 style="margin:0 0 0.5rem 0; font-size:1.6rem; color:#fff;">${data.title}</h2><div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem; line-height:1.6; color:#cbd5e1;"><strong>Location:</strong> ${data['LOCATION'] || 'N/A'}<br><strong>Status:</strong> ${data['STATUS'] || 'Unknown'}<br><strong>Type:</strong> ${data['TYPE'] || 'Fire'}<br><strong>Size:</strong> ${data['SIZE'] || '-'}<br><strong>Agency:</strong> ${data['RESPONSIBLE AGENCY'] || 'RFS'}</div><div style="font-size:0.8rem; color:#94a3b8; margin-bottom:1rem;">Updated: ${data['UPDATED'] || 'Recently'}</div>
      
      <a href="${data.link}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:inline-block; width:100%; text-align:center; margin-bottom:1.5rem;">View on Fires Near Me</a>
      
      <hr style="border:0; border-top:1px solid var(--border-subtle); margin:0 0 1.5rem 0;">
      <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--text-soft); letter-spacing:0.1em; margin-bottom:0.5rem;">User Incident Log (External)</h3>
      ${updatesHtml}`;
    }
    async function showIncidentDetails(incident) {
      const sidebar = document.getElementById('incident-sidebar');
      const content = document.getElementById('sidebar-content');
      sidebar.classList.add('open');
      content.innerHTML = '<p style="color:var(--text-soft);">Loading details...</p>';
      const { data: updates } = await supabase.from('incident_updates').select('*').eq('incident_id', incident.id).order('created_at', { ascending: false });
      let updatesHtml = updates && updates.length > 0 ? `<div class="update-timeline">` + updates.map(u => `<div class="update-item"><div class="update-time">${new Date(u.created_at).toLocaleString()}</div><div class="update-msg markdown-body">${marked.parse(u.message)}</div></div>`).join('') + `</div>` : '<div style="font-size:0.85rem; color:var(--text-soft); margin-top:1rem; font-style:italic;">No updates yet.</div>';
      let agenciesHtml = '';
      if (incident.responding_agencies && incident.responding_agencies.length > 0) { agenciesHtml = `<div style="margin-bottom:0.8rem;">` + incident.responding_agencies.map(a => `<span class="${getAgencyClass(a)}">${a}</span>`).join(' ') + `</div>`; }
      const typesList = Array.isArray(incident.type) ? incident.type : [incident.type];
      const typesHtml = typesList.map(t => `<span class="badge-type">${t}</span>`).join('');
      content.innerHTML = `
        <div style="margin-bottom:0.5rem;">${typesHtml}</div>
        <h2 style="margin:0 0 0.5rem 0; font-size:1.6rem; color:#fff;">${incident.title}</h2>
        <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem; line-height:1.6; color:#cbd5e1;">
          <strong>Status:</strong> ${incident.status || 'Active'}<br>
          <strong>Size:</strong> ${incident.size || '-'}<br>
          <strong>Expires:</strong> ${new Date(incident.expires_at).toLocaleString()}
        </div>
        ${agenciesHtml}
        <div class="markdown-body" style="color:#cbd5e1; font-size:0.95rem; line-height:1.6; margin-top:0.5rem;">${marked.parse(incident.description || 'No description provided.')}</div>
        <hr style="border:0; border-top:1px solid var(--border-subtle); margin:1.5rem 0;">
        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--text-soft); letter-spacing:0.1em; margin-bottom:0.5rem;">Incident Log</h3>
        ${updatesHtml}
      `;
    }
    function getAgencyClass(agency) { const a = agency.toUpperCase(); if(a.includes('RFS')) return 'pill pill-agency-rfs'; if(a.includes('FRNSW')) return 'pill pill-agency-frnsw'; if(a.includes('NSWAS')) return 'pill pill-agency-amb'; if(a.includes('SES')) return 'pill pill-agency-ses'; if(a.includes('POLICE')) return 'pill pill-blue'; if(a.includes('VRA')) return 'pill pill-white'; return 'pill pill-agency-util'; }
    function getPinStyle(inc) {
      let colors = [];
      if (inc.responding_agencies && inc.responding_agencies.length > 0) { inc.responding_agencies.forEach(a => { const c = AGENCY_COLORS[a.toUpperCase()]; if (c) colors.push(c); }); }
      if (colors.length === 0) {
        const t = (Array.isArray(inc.type) ? inc.type.join(' ') : inc.type).toUpperCase();
        if (t.includes('FIRE')) colors.push(TYPE_COLORS.FIRE); else if (t.includes('RESCUE') || t.includes('MVA')) colors.push(TYPE_COLORS.RESCUE); else if (t.includes('HAZARD')) colors.push(TYPE_COLORS.HAZARD); else if (t.includes('POLICE')) colors.push(TYPE_COLORS.POLICE); else if (t.includes('CARDIAC')) colors.push(TYPE_COLORS.MEDICAL); else colors.push(TYPE_COLORS.DEFAULT);
      }
      let background = colors[0];
      if (colors.length > 1) { const segment = 360 / colors.length; let grad = 'conic-gradient('; colors.forEach((c, i) => { grad += `${c} ${i * segment}deg ${(i + 1) * segment}deg${i < colors.length - 1 ? ', ' : ''}`; }); grad += ')'; background = grad; }
      return { background: background, glow: colors[0] };
    }
    
    // --- REALTIME IMPLEMENTATION ---

    function handleRealtimeEvent() {
        console.log("Realtime event received. Refreshing map data.");
        // Re-run the main data loading function to pull fresh data from both Supabase and the RFS feed
        loadAllData();
    }

    function setupRealtimeSubscription() {
      // 1. Subscribe to changes on the incidents table
      supabase
        .channel('incidents-updates')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'incidents' }, handleRealtimeEvent)
        .subscribe();
      
      // 2. Subscribe to changes on the incident_updates (logs) table
      supabase
        .channel('log-updates')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'incident_updates' }, handleRealtimeEvent)
        .subscribe();
      
      console.log("Supabase Realtime Subscriptions started.");
    }
    
    // NEW: Search function to call on button click or Enter
    const searchInput = document.getElementById('address-search');
    const resultsBox = document.getElementById('search-results');

    async function performAddressSearch() {
        const query = searchInput.value;
        if(query.length <= 3) return;
        
        resultsBox.innerHTML = '<div style="padding:0.8rem; color:var(--text-soft);">Searching...</div>'; resultsBox.style.display = 'block';
        try { 
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=au`); 
          const data = await res.json();
          resultsBox.innerHTML = ''; 
          if(data.length === 0) { resultsBox.innerHTML = '<div style="padding:0.8rem;">No results found.</div>'; return; }
          data.forEach(place => { 
            const div = document.createElement('div'); 
            div.className = 'search-result-item'; 
            div.innerText = place.display_name; 
            div.onclick = () => { map.setView([place.lat, place.lon], 14); resultsBox.style.display = 'none'; searchInput.value = ''; }; 
            resultsBox.appendChild(div); 
          });
        } catch(err) { resultsBox.innerHTML = 'Error.'; }
    }

    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') performAddressSearch();
    });
    
    document.addEventListener('click', function(event) { if (!resultsBox.contains(event.target) && event.target !== searchInput) { resultsBox.style.display = 'none'; } });

    // Initial data load + Realtime setup on page load
    loadAllData();
    setupRealtimeSubscription();
  </script>
</body>
</html>