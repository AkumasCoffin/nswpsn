<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NSW PSN – Live Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    /* LAYOUT OVERRIDES */
    body, html { width: 100%; height: 100%; overflow: hidden; padding: 0 !important; margin: 0 !important; }
    
    #map-layout-root {
      position: absolute; top: 0; left: 260px; right: 0; bottom: 0;
      width: auto !important; height: 100% !important; padding: 0 !important; margin: 0 !important;
      max-width: none !important;
    }

    @media (max-width: 900px) {
      #map-layout-root { left: 0; top: 60px; height: calc(100% - 60px); }
    }

    .map-container { width: 100%; height: 100%; position: relative; }
    #map { width: 100%; height: 100%; background: #0f172a; z-index: 1; }

    /* TOGGLES */
    .layer-toggles {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 800;
      display: flex; gap: 10px; background: rgba(15, 23, 42, 0.9); padding: 6px 12px;
      border-radius: 50px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .btn-toggle {
      background: transparent; border: none; color: #cbd5e1; padding: 6px 10px; border-radius: 20px;
      font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;
      transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .btn-toggle:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .btn-toggle.active { background: rgba(255, 255, 255, 0.1); color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .btn-toggle.active#btn-user { border: 1px solid #a855f7; color: #d8b4fe; }
    .btn-toggle.active#btn-rfs { border: 1px solid #ef4444; color: #fca5a5; }
    .btn-toggle:not(.active) { opacity: 0.6; text-decoration: line-through; text-decoration-thickness: 1.5px; }
    .dot-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .btn-toggle.active .dot-indicator { box-shadow: 0 0 8px currentColor; }

    /* SIDEBAR & BADGES */
    .map-sidebar {
      width: 350px; background: rgba(15, 23, 42, 0.95); border-left: 1px solid rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(12px); padding: 1.5rem; overflow-y: auto; position: absolute; right: 0; top: 0;
      height: 100%; z-index: 1005; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; box-shadow: -5px 0 25px rgba(0,0,0,0.5);
    }
    .map-sidebar.open { transform: translateX(0); }
    .badge-type { background: #1e293b; border: 1px solid rgba(148, 163, 184, 0.35); color: #cbd5e1; font-size: 0.7rem; padding: 0.1rem 0.5rem; border-radius: 4px; margin-right: 0.25rem; display: inline-block; }
    
    .rfs-pulse { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-red 2s infinite; border-radius: 50%; }
    @keyframes pulse-red {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
  </style>
</head>
<body>
  <div class="mobile-header">
    <div class="mobile-logo">Forcequit <span>Map</span></div>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
  </div>

  <div class="menu-overlay" onclick="toggleSidebar()"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">Forcequit <span>NSW PSN</span></div>
    <div class="sidebar-subtitle">Operations Map</div>
    <div class="sidebar-section-label">Sections</div>
    <nav class="sidebar-nav">
      <a href="index.html">Home / Overview</a>
      <a href="live.html" style="color: #fca5a5;">Live Data / Scanner</a>
      <a class="active" href="map.html" style="color: #fca5a5;">Incident Map</a>
      <a href="fire-and-rescue.html">Fire and Rescue NSW</a>
      <a href="ambulance.html">NSW Ambulance</a>
      <a href="rural-fire-service.html">NSW Rural Fire Service</a>
      <a href="aviation.html">Aviation &amp; Callsigns</a>
      <a href="links.html">Useful Links</a>
    </nav>

    <div class="sidebar-section-label">Legal</div>
    <nav class="sidebar-nav">
      <a href="terms.html">Terms &amp; Conditions</a>
      <a href="privacy.html">Privacy Policy</a>
    </nav>

    <div class="sidebar-section-label">Live Scanner</div>
    <div class="sidebar-highlight">
      <div class="sidebar-highlight-title">NSW PSN Scanner</div>
      <div>Hosted by Forcequit</div>
      <div style="margin-top:0.45rem;">
        <a
          class="listen-btn-wide"
          href="https://radio.forcequit.xyz/"
          target="_blank"
          rel="noopener noreferrer"
        >
          Live feed
        </a>
      </div>
      <div style="margin-top:0.45rem;">
        <a
          class="discord-btn-wide"
          href="https://discord.gg/BthQzXj6Ck"
          target="_blank"
          rel="noopener noreferrer"
        >
          Support Discord
        </a>
      </div>
      <div style="margin-top:0.25rem; font-size:0.7rem; color:var(--text-soft);">
        radio.forcequit.xyz
      </div>
    </div>
    
    <div class="sidebar-footer">NSW PSN Reference · Forcequit</div>
  </aside>

  <main class="main" id="map-layout-root">
    <div class="map-container">
      <div id="map"></div>
      
      <div class="layer-toggles">
        <button id="btn-user" class="btn-toggle active" onclick="toggleMapLayer('user')">
          <span class="dot-indicator" style="background:#a855f7;"></span> User
        </button>
        <button id="btn-rfs" class="btn-toggle active" onclick="toggleMapLayer('rfs')">
          <span class="dot-indicator" style="background:#ef4444;"></span> RFS
        </button>
      </div>

      <div class="map-sidebar" id="incident-sidebar">
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="closeIncidentSidebar()" style="padding:0.4rem 0.8rem; font-size:0.75rem;">Close ✕</button>
        </div>
        <div id="sidebar-content" style="margin-top:1rem;">
          <div style="text-align:center; color:var(--text-soft); margin-top:2rem;">
            Select a pin on the map<br>to view details.
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://wwcickcmezfrcqyclcuo.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3Y2lja2NtZXpmcmNxeWNsY3VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODI3NDIsImV4cCI6MjA4MDA1ODc0Mn0.xP9I9vAbBB-1afCpnOAwLJeoKTF2Dmewwv-aCKVXKrQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const map = L.map('map', { zoomControl: false }).setView([-33.8688, 151.2093], 7);
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const userLayer = L.layerGroup().addTo(map);
    const rfsLayer = L.layerGroup().addTo(map);

    // COLORS
    // Note: 'VRA' is set to #000000 so it appears WHITE after inversion
    const AGENCY_COLORS = { 'RFS': '#ff6600', 'FRNSW': '#ef4444', 'NSWAS': '#3b82f6', 'SES': '#eab308', 'POLICE': '#3b82f6', 'VRA': '#000000', 'AVIATION': '#a855f7' };
    
    // CHANGED: Default is now Black (#000000) so it INVERTS to White on the map
    const TYPE_COLORS = { 'FIRE': '#ef4444', 'RESCUE': '#ff6600', 'HAZARD': '#eab308', 'POLICE': '#3b82f6', 'MEDICAL': '#3b82f6', 'DEFAULT': '#000000' };

    function toggleMapLayer(target) {
      const btn = document.getElementById(target === 'user' ? 'btn-user' : 'btn-rfs');
      const layer = target === 'user' ? userLayer : rfsLayer;
      if (map.hasLayer(layer)) { map.removeLayer(layer); btn.classList.remove('active'); } 
      else { map.addLayer(layer); btn.classList.add('active'); }
    }

    // 1. USER PINS
    async function loadIncidents() {
      const nowISO = new Date().toISOString();
      const { data: incidents, error } = await supabase.from('incidents').select('*').gt('expires_at', nowISO);
      if (error) console.error(error);
      
      userLayer.clearLayers();

      if(incidents) {
        incidents.forEach(inc => {
          const style = getPinStyle(inc);
          const iconHtml = `<div style="background:${style.background}; width:24px; height:24px; border-radius:50%; border:3px solid #fff; box-shadow:0 0 10px ${style.glow}, 0 0 20px ${style.glow};"></div>`;
          const icon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [30,30], iconAnchor: [15,15] });
          const marker = L.marker([inc.lat, inc.lng], { icon: icon }).addTo(userLayer);
          marker.on('click', () => showIncidentDetails(inc));
        });
      }
    }

    // 2. RFS FEED
    async function loadRfsFeed() {
      try {
        const res = await fetch("https://www.rfs.nsw.gov.au/feeds/majorIncidents.xml");
        const text = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");
        const items = xml.querySelectorAll("item");

        rfsLayer.clearLayers();

        items.forEach(item => {
          const title = item.querySelector("title").textContent;
          const link = item.querySelector("link").textContent;
          const descHtml = item.querySelector("description").textContent;
          const pointStr = item.querySelector("point") ? item.querySelector("point").textContent : null;
          const polygonStr = item.querySelector("polygon") ? item.querySelector("polygon").textContent : null;
          const category = item.querySelector("category") ? item.querySelector("category").textContent : "Advice";

          const details = parseRfsDescription(descHtml);
          details.title = title; details.link = link;

          // --- FIXED COLOR LOGIC ---
          // Default is #000000 (Black) -> Inverts to White
          let color = '#000000'; 
          let pulseClass = '';
          const catLower = category.toLowerCase();

          if(catLower.includes('emergency')) { color = '#ef4444'; pulseClass = 'rfs-pulse'; } // Red
          else if(catLower.includes('watch')) { color = '#f97316'; } // Orange
          else if(catLower.includes('advice')) { color = '#3b82f6'; } // Blue
          else if(catLower.includes('not applicable')) { color = '#000000'; } // Explicitly Black -> White
          
          if (polygonStr) {
            const coords = polygonStr.trim().split(' ').reduce((acc, val, i, arr) => {
              if (i % 2 === 0) acc.push([parseFloat(val), parseFloat(arr[i+1])]);
              return acc;
            }, []);
            L.polygon(coords, { color: color, weight: 2, fillOpacity: 0.3 }).addTo(rfsLayer).bindPopup(`<b>${title}</b><br>${category}`);
            if(pointStr) {
              const [lat, lng] = pointStr.split(' ').map(Number);
              createRfsMarker(lat, lng, color, pulseClass, details);
            }
          } else if (pointStr) {
            const [lat, lng] = pointStr.split(' ').map(Number);
            createRfsMarker(lat, lng, color, pulseClass, details);
          }
        });
      } catch (err) { console.error("RFS Feed Error:", err); }
    }

    function createRfsMarker(lat, lng, color, pulseClass, details) {
      const iconHtml = `<div class="${pulseClass}" style="background:${color}; width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 8px ${color};"></div>`;
      const icon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [24,24], iconAnchor: [12,12] });
      const marker = L.marker([lat, lng], { icon: icon }).addTo(rfsLayer);
      marker.on('click', () => showRfsDetails(details));
    }

    function parseRfsDescription(html) {
      const clean = html.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>?/gm, '');
      const lines = clean.split('\n');
      let data = {};
      lines.forEach(line => {
        const parts = line.split(':');
        if(parts.length > 1) { data[parts[0].trim().toUpperCase()] = parts.slice(1).join(':').trim(); }
      });
      return data;
    }

    function showRfsDetails(data) {
      const sidebar = document.getElementById('incident-sidebar');
      const content = document.getElementById('sidebar-content');
      sidebar.classList.add('open');
      
      let badgeClass = "pill-white";
      const lvl = (data['ALERT LEVEL'] || '').toLowerCase();
      if(lvl.includes('emergency')) badgeClass = "pill-red";
      else if(lvl.includes('watch')) badgeClass = "pill-orange";
      else if(lvl.includes('advice')) badgeClass = "pill-blue";

      content.innerHTML = `
        <div style="margin-bottom:0.5rem;">
          <span class="pill pill-agency-rfs">NSW RFS FEED</span>
          <span class="pill ${badgeClass}">${data['ALERT LEVEL'] || 'Incident'}</span>
        </div>
        <h2 style="margin:0 0 0.5rem 0; font-size:1.6rem; color:#fff;">${data.title}</h2>
        <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem; line-height:1.6; color:#cbd5e1;">
          <strong>Location:</strong> ${data['LOCATION'] || 'N/A'}<br>
          <strong>Status:</strong> ${data['STATUS'] || 'Unknown'}<br>
          <strong>Type:</strong> ${data['TYPE'] || 'Fire'}<br>
          <strong>Size:</strong> ${data['SIZE'] || '-'}<br>
          <strong>Agency:</strong> ${data['RESPONSIBLE AGENCY'] || 'RFS'}
        </div>
        <div style="font-size:0.8rem; color:#94a3b8; margin-bottom:1rem;">Updated: ${data['UPDATED'] || 'Recently'}</div>
        <a href="${data.link}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:inline-block; width:100%; text-align:center;">View on Fires Near Me</a>
      `;
    }

    async function showIncidentDetails(incident) {
      const sidebar = document.getElementById('incident-sidebar');
      const content = document.getElementById('sidebar-content');
      sidebar.classList.add('open');
      content.innerHTML = '<p style="color:var(--text-soft);">Loading details...</p>';
      const { data: updates } = await supabase.from('incident_updates').select('*').eq('incident_id', incident.id).order('created_at', { ascending: false });
      let updatesHtml = updates && updates.length > 0 ? `<div class="update-timeline">` + updates.map(u => `<div class="update-item"><div class="update-time">${new Date(u.created_at).toLocaleString()}</div><div class="update-msg markdown-body">${marked.parse(u.message)}</div></div>`).join('') + `</div>` : '<div style="font-size:0.85rem; color:var(--text-soft); margin-top:1rem; font-style:italic;">No updates yet.</div>';
      
      let agenciesHtml = '';
      if (incident.responding_agencies && incident.responding_agencies.length > 0) {
        agenciesHtml = `<div style="margin-bottom:0.8rem;">` + incident.responding_agencies.map(a => `<span class="${getAgencyClass(a)}">${a}</span>`).join(' ') + `</div>`;
      }
      const typesList = Array.isArray(incident.type) ? incident.type : [incident.type];
      const typesHtml = typesList.map(t => `<span class="badge-type">${t}</span>`).join('');

      content.innerHTML = `
        <div style="margin-bottom:0.5rem;">${typesHtml}</div>
        <h2 style="margin:0 0 0.5rem 0; font-size:1.6rem; color:#fff;">${incident.title}</h2>
        ${agenciesHtml}
        <div class="markdown-body" style="color:#cbd5e1; font-size:0.95rem; line-height:1.6; margin-top:0.5rem;">${marked.parse(incident.description || 'No description provided.')}</div>
        <div style="font-size:0.7rem; color:var(--text-soft); margin-top:1rem;">Expires: ${new Date(incident.expires_at).toLocaleString()}</div>
        <hr style="border:0; border-top:1px solid var(--border-subtle); margin:1.5rem 0;">
        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--text-soft); letter-spacing:0.1em; margin-bottom:0.5rem;">Incident Log</h3>
        ${updatesHtml}
      `;
    }

    function closeIncidentSidebar() { document.getElementById('incident-sidebar').classList.remove('open'); }
    function getAgencyClass(agency) { const a = agency.toUpperCase(); if(a.includes('RFS')) return 'pill pill-agency-rfs'; if(a.includes('FRNSW')) return 'pill pill-agency-frnsw'; if(a.includes('NSWAS')) return 'pill pill-agency-amb'; if(a.includes('SES')) return 'pill pill-agency-ses'; if(a.includes('POLICE')) return 'pill pill-blue'; if(a.includes('VRA')) return 'pill pill-white'; return 'pill pill-agency-util'; }
    function getPinStyle(inc) {
      let colors = [];
      if (inc.responding_agencies && inc.responding_agencies.length > 0) { inc.responding_agencies.forEach(a => { const c = AGENCY_COLORS[a.toUpperCase()]; if (c) colors.push(c); }); }
      if (colors.length === 0) {
        const t = (Array.isArray(inc.type) ? inc.type.join(' ') : inc.type).toUpperCase();
        if (t.includes('FIRE')) colors.push(TYPE_COLORS.FIRE); else if (t.includes('RESCUE') || t.includes('MVA')) colors.push(TYPE_COLORS.RESCUE); else if (t.includes('HAZARD')) colors.push(TYPE_COLORS.HAZARD); else if (t.includes('POLICE')) colors.push(TYPE_COLORS.POLICE); else if (t.includes('CARDIAC')) colors.push(TYPE_COLORS.MEDICAL); else colors.push(TYPE_COLORS.DEFAULT);
      }
      let background = colors[0];
      if (colors.length > 1) {
        const segment = 360 / colors.length;
        let grad = 'conic-gradient(';
        colors.forEach((c, i) => { grad += `${c} ${i * segment}deg ${(i + 1) * segment}deg${i < colors.length - 1 ? ', ' : ''}`; });
        grad += ')'; background = grad;
      }
      return { background: background, glow: colors[0] };
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.menu-overlay').classList.toggle('active'); }

    loadIncidents();
    loadRfsFeed();
    setInterval(() => { loadIncidents(); loadRfsFeed(); }, 60000);
  </script>
</body>
</html>